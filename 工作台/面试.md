
## 技术难点

### 难点1 ： BI多边形报表

关键库 react-grid-layout、react-dnd、react-dnd-html5-backend、domtoimage
1. DndProvider 用于实现图表组件的拖拽
2. DragSource：使组件能够被拖拽
3. DropTarget： 拖拽放置区域 
4. react-grid-layout：提供grid布局，传入对象数组layout
#### 实现过程

1. DragItem 封装组件，使其可被拖拽
2. pageWidgetContainer 拖拽面板封装，DropTarget
3. Widget：放置图表组件（表格、文字、搜索、还有如antd提示框、自定义的数字卡片等）

### 难点2: 客服聊天

关键技术 ： socket.io-client 、 IM

socket(link带token)

#### api
on 监听
1.  events ，根据返回的type区分处理响应事件
2. exception： 异常处理
3. disconnnect: 断开

#### 第二种方案

IM \ WebRTC 第三方封装的SDK

API

```jsx
import SDK from '@/common/components-x/IMDemo/sdk/js/NIM_Web_SDK_v8.4.0'
import WebRTC from '@/common/components-x/IMDemo/sdk/js/NIM_Web_WebRTC_v8.4.0'

// 初始化
SDK?.NIM?.use(WebRTC)

SDK?.NIM?.getInstance({
token
account
appKey
})

```

1. disconnect
2. sendText
3. sendCustomMsg
4. deleteMsg // 撤回
5. \setCurrSession // IM同步完成，设置会话
6. getLocalMsgs

### 技术难点3: 打印单据

关键技术： Hiprint

实现过程
1. hiprint的css和js下载下来
2. 自定义json，也就是模版格式（这里要先设计好template，然后导出json）
3. new hiprint.PrintTemplate 实例传入json格式的template
4. 调用实例的print方法，传入打印的数据

### 技术难点4: common组件



### 技术难点5: 跨页面单点登录

两个平台需要公用登录态，而这些平台不一样，为解决跨域通信、保持token状态一致，选用了iframe+postmessage的方式作为解决方案

#### 解决要点

1. 两个平台监听是双向的，登录token失效等都要通知
2. iframe 加载B平台的sso.html页面，postmessage发送token信息，payload类型为sharetoken
3. 失效的时候，postmessage则发送token信息，payload类型为tokeninvid，这样sso.html清除storage的token，其他页面监听storage的变化后，跳转登录页
4. build打包时，添加输出sso.html
#### 实现
```jsx
window.**addEventListener**('storage')
window.**addEventListener**( 'message',)
// 动态创建一个不可见的iframe，在iframe中加载一个跨域HTML 
const iframe = document.**createElement**('iframe') iframe.src = `${host}/sso.html` iframe.style.display = 'none' document.body.**append**(iframe)

// 打包输出
```TypeScript
// build.plugin.js

fs.copySync(path.join(__dirname, `/build/${RELEASE}/sso.html`), path.join(__dirname, '/build/sso.html'))

```

一些注意的点
-   在safari浏览器，加载iframe会弹出阻止提示，需要设置允许；postMessage跨站点传输数据会被禁止，要在**偏好设置-> 隐私-> 网站跟踪** 去掉阻止跨站跟踪，如图
- 加载iframe时，谷歌浏览器可以在iframe.onload回调中打开新窗口，但是safari浏览器会打开失败，所以进行了兼容处理，非谷歌浏览器会等待100ms，再传递信息
